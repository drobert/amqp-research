<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:c="http://www.springframework.org/schema/c"
	xmlns:int="http://www.springframework.org/schema/integration"
    xmlns:rabbit="http://www.springframework.org/schema/rabbit"
	xmlns:int-amqp="http://www.springframework.org/schema/integration/amqp"
	xmlns:p="http://www.springframework.org/schema/p"
	xmlns:context="http://www.springframework.org/schema/context"
	xsi:schemaLocation="http://www.springframework.org/schema/integration/amqp http://www.springframework.org/schema/integration/amqp/spring-integration-amqp-4.0.xsd
		http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration-4.0.xsd
		http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
		http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.0.xsd
        http://www.springframework.org/schema/rabbit http://www.springframework.org/schema/rabbit/spring-rabbit-1.3.xsd">

	<context:property-placeholder />
	<import resource="amqp-context.xml" />
	
	<!-- events are all going to the exchange, so make a temporary, anonymous queue and add appropriate routing rules to the exchange -->
	<rabbit:queue id="prodClicksQueue" name="prodClicksQueue" auto-delete="true" durable="false" />
	
	<rabbit:topic-exchange id="etlExchange" name="${mq.exchange.etl:etl-demo}" auto-delete="true" durable="false">
		<rabbit:bindings>
			<!-- this consumer only cares about product etl executions -->
			<rabbit:binding pattern="prd.#" queue="prodClicksQueue" />
		</rabbit:bindings>
	</rabbit:topic-exchange>
	
	<!-- some custom error handling -->	
	<int:logging-channel-adapter id="errorLogger" level="INFO" logger-name="STDERR" />
	
	<int:channel id="etl-in" />
	
	<!-- look, ma, normal beans -->
	<bean id="etlConsumer" class="name.danielrobert.amqp.ConsumerFilter">
		<constructor-arg>
			<set><value>SUCCESS</value><value>FAILURE</value></set>
		</constructor-arg>
	</bean>
	<bean id="etlCache" class="name.danielrobert.amqp.EtlCache" />
	
	<int-amqp:inbound-channel-adapter channel="etl-in" queue-names="prodClicksQueue" connection-factory="amqpConnectionFactory"/>
	
	<int:chain input-channel="etl-in">
		<int:transformer method="fromMessage">
			<bean class="name.danielrobert.amqp.EtlExecution" />
		</int:transformer>
		<int:filter ref="etlConsumer" method="relevant" />
		<int:transformer ref="etlConsumer" method="hack" />
		<int:outbound-channel-adapter ref="etlCache" method="cache" />
	</int:chain>

</beans>
